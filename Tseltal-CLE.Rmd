---
title             : "Child language experience in a Tseltal Mayan village"
shorttitle        : "Child language experience in a Tseltal Mayan village"

author: 
  - name          : "Marisa Casillas"
    affiliation   : "1"
    corresponding : yes    # Define only one corresponding author
    address       : "Wundtlaan 1, 6525 XD Nijmegen, The Netherlands"
    email         : "Marisa.Casillas@mpi.nl"
  - name          : "Penelope Brown"
    affiliation   : "1"
  - name          : "Stephen C. Levinson"
    affiliation   : "1"

affiliation:
  - id            : "1"
    institution   : "Max Planck Institute for Psycholinguistics"
#  - id            : "2"
#    institution   : "Cambridge University"

#author_note: |
#  Add complete departmental affiliations for each author here. Each new line herein must be indented, like this line.

abstract: |
  Enter abstract here. Each new line herein must be indented, like this line.
  
keywords          : "keywords"
wordcount         : "X"

bibliography      : ["r-references.bib"]

figsintext        : no
figurelist        : no
tablelist         : no
footnotelist      : no
lineno            : yes
mask              : no

class             : "man"
output            : papaja::apa6_pdf
---

```{r load_packages, include=FALSE, echo=FALSE, warning=FALSE}
library(papaja)
library(ggplot2)
library(tidyverse)
library(viridis)
library(grid)
library(gridExtra)
library(ggpirate)
source("0-Helper.R")
```

```{r analysis_presets, include=FALSE}
data.path <- "transcripts/anon/" # text files exported from ELAN
plot.path <- "plots/" # output plots
seg.index.file <- "Segment-order-inventory.csv"
ptcp.info.file <- "recording-info.csv"
samplelabels <- c("High activity  ", "Random  ")
col.sample.bu <- list(
  scale_fill_manual(labels=samplelabels, values=viridis(2)),
  scale_color_manual(labels=samplelabels, values=viridis(2)))
col.sample.bu3 <- list(
  scale_fill_manual(labels=samplelabels, values=viridis(3)),
  scale_color_manual(labels=samplelabels, values=viridis(3)))
allowed.overlap <- 1000 #ms
allowed.gap <- 2000 #ms
sem <- function (x) {
    sd(x) / sqrt(length(x))
}
```

# Introduction
Much of developmental language science revolves around one central question: what linguistic evidence (i.e., what types and how much) is needed to support first language acquisition? Early claims about children's language environments characterized linguistic `input' as syntactically complex and error-prone, with no negative evidence (REFS). However, decades of work has overturned this view entirely: the speech that children hear and use in their interactions with others is rich with multimodal information that children can leverage to infer linguistic knowledge. In fact, children's own speech productions appear to closely mirror the stochastic patterns in their linguistic input (REFS), convincingly accounting for the kinds of errors children do and don't make in spontaneous speech (REFS; see also REFS for similar work regarding phonological learning).

In the last two decades, the role of children's linguistic environments on their language development has become a topic of intense focus in developmental psychology, with studies showing repeatedly that the amount of child-directed speech (CDS) children hear influences their language development, particularly their vocabulary (REFS). For example, [TO DO: Fill in later]. Some studies have also linked the quantity of directed speech children hear to their speed of lexical retrieval and their syntactic development (REFS; Weisleder; LuCiD; Huttenlocher). [TO DO: Fill in later after reading Huttenlocher]. Child-directed speech estimates have traditionally come from short at-home or in-lab video recordings of caregiver-child interaction. But recently many researchers have also used daylong audio recordings (e.g., with the LENA(C) system) to track the approximate amount of spoken language in children's at-home language environments; tracking information about how much of the talk is child-directed by annotating sub-samples of the recording (REFS; Weisleder) or looking at other cues to interactional behavior (REFS; Romeo). 

The conclusion drawn in much of this work is that child-directed speech is the ideal register for learning words; especially for _referential_ word learning (i.e., concrete nouns and verbs; REFS). In line with this idea, experimental studies have conclusively shown that infant-directed speech is nearly universally preferred over adult-directed speech by young children (REFS ManyBabies, etc.). Perhaps more importantly, child-directed speech is often produced under conditions of joint activity, in which caregivers and children coordinate their behavior in order to accomplish interactional goals (e.g., daily routines of feeding, diaper changing, and play). Using head-mounted eyetrackers, Chen Yu and colleagues (REFS) have demonstrated that coordination during object-play exchanges [TO DO: Fill in later]. Crucially, then, estimates of child-directed speech quantity may functionally predict children's word learning because they index the frequency with which children engage in rich, multimodal interactions with their caregivers; interactions in which children can actively and contingently elicit just the right linguistic information at just the right time to be optimally interesting and useful for learning (REFS; Eve's paper on homophonic Vs in French).

There are, however, a few very important caveats to this body of work relating CDS quantity and language development. First, while there is overwhelming evidence linking CDS quantity to vocabulary size, links to grammatical development are much more scant (REFS: Huttenlocher; others???).  Learning a language involves mastery of its systemic underpinnings, e.g., its phonology, morphology, and syntax. While there is clear reason for CDS to have referentially more clear speech (good for learning concrete vocabulary), there is less clear reason for it to do the same for grammatical information. [Start with Yurovsky paper + refrences therein] 

<!--A lack of evidence linking input to grammatical outcomes may partly be more scant for practical reasons (e.g., there is no similarly convenient metric like the CDI; REFS).-->

<!--means are meaningless if the thing that matters is some threshhold of interaction. well, not fully if we take evidence from cross-situational learning in wihch # of exposures matters, but even then we might expect bursty exposures to be more effective than non-bursty ones if memory is an issue... isn't there a Lew-Williams paper along these lines?-->



- However, there are two major caveats to this work, all interrelated with each other:
  - 1: While evidence linking input and vocab is super strong, evidence linking input to grammar is more scant; aspects of the system may be differentially sensitive to experience (Dan's paper)
  - 2: Literacy-centric view of language development; what is the 'target'?
  - 3: Focused on WEIRD kids


<!--- Children require linguistic input to become full-fledged speakers of their language(s)
- As developmentalists, our ultimate goal is to be able to model the diverse mechanisms that allow children to convert the linguistic information in their environment to internalized linguistic knowledge, e.g., (statistical learning, motor development, etc.; see slides)
- We have (rightfully) spent an enormous amount of time analyzing what information exists in children's input—such information is an important jumping off point for inspiring and constraining theories about learning mechanisms
- We have developed many techniques for tracking input, most recently daylong recordings
  - Extoll the virtues of daylong recordings
  - Indeed, studies along these lines, linking children's language experience to their language outcomes, finds a strong impact of experience, especiall with respect to CDS
    - List some findings on input effects
    - Why is CDS special? Briefly list findings-->
- However, there are two major caveats to this work, all interrelated with each other:
  - 1: While evidence linking input and vocab is super strong, evidence linking input to grammar is more scant; aspects of the system may be differentially sensitive to experience (Dan's paper)
  - 2: Literacy-centric view of language development; what is the 'target'?
  - 3: Focused on WEIRD kids
- A key avenue for addressing these issues is to promote further study of lg development in non-WEIRD contexts.
  - Linguistic anthropologists have been doing this for a long time
  - Now it's time for us to follow-up using our own methods so that we can more feasibly compare
    - Though that comes with its own problems (cite...)
  - Especially in less-literate/semi-literate communities, it lets us more easily think about language acquisition apart from literacy
- In this paper we examine the linguistic experiences of 10 Tseltal Mayan children. Why Mayan?
  - Non-WEIRD
  - Rich area of research: Little CDS from report—potentially a great case for looking at a functioning acquisition system with minimal environmental input
  - Many linguistically and culturally similar communities for comparison (see Shneidman, Pye, etc.)
  - See slides for more
  - A major contribution of this work is to use daylong recordings, which allow us to estimate... (TLM paper on short vs. longer recs).
    - At the same time, there is potentially great value in knowing about what happens during interactional bursts when they happen, so we track ... tt and va as well
- Our aim is to develop a child language environment profile for Tseltal Mayan, one that gives an impression of the speech children hear around them and the type of speech that is addressed to them directly. <Describe corpus and lay out basic questions (see results below)>
- Results:
  - How much speech do children hear overall and what proportion of that is directed to them? How does that compare to other communities we've studied?
    - *measures*: XDS and TDS minutes per hour and proportion (from random selections only)
  - How do ADS and TDS differ?
    - *measures*: utt length, repetitiveness, F0 peaks and ranges, questions, imperatives (?)
  - How much speech do children hear during bouts/bursts of interaction? How often do these bursts occur?
    - *measures*: deltas for m/h TDS, #utts TDS, # TT transitions between random, tt, and va: are they actually different?
    - *measures*: XDS and TDS minutes per hour and proportion (from tt and va selections: do they show similar age effects?)
    - *measures*: sliding window in random to match mean TDS rate/TT transition rates
  - Does interaction influence linguistic practice?
    - *measures*: m/h CHI vocs, # CHI vocs, & voc mat between random, tt, and va
- Discussion
  - Summary of findings
  - When thinking about quantity: Do we care about the avg over the day or do bursts matter more?
    - Benefits of naps between bursts? Natural input cycle? How many 'good' minutes are enough to spur learning on?
  - How should we think about CDS? What is universal about its format?
  - So what is the impact of input in this community? What do we predict?
    - One point often raised: do these kids show a delay? Problematize this.
    - More interesting: language experience itself shapes use of mechanisms for learning, e.g., learning fro overhearing (Shneidman)
  - Big issue we have to face as work continues in this vein: what are these kids learning? We can't continue to pretend that we are capable of defining and encapsulating a phenomenon as emergent as language.
  - Limitations
    - no video data
    - only 10 kids

# Methods
## How to define temporal contingency for turn taking
Many other studies of child-caregiver turn taking use an arbitrary cut-off for detecting contingency (5 seconds?? Look up references). We base ours on measures of turn taking in interactions with infants and young children. Hilbrink et al. (2015) looked at interaction in a longitudinal corpus from 3 to 18 months and found that infants' responses to mothers began between -700ms and 1200ms relative to the end of the mothers' turns. Complementarily, mothers' responses to infant vocalizations began between -350ms and 650ms relative to the end of the infants' turns. Casillas et al. (2016) investigated the timing of question-answer responses from caregiver to child and from child to caregiver with children between 20 and 35 months. In their study, children's responses typically started between -500ms and 650ms relative to the end of their caregivers' turns. Caregivers' responses typically started between -1000ms and 400ms relative to the end of their children's turns. Because both studies focused on fairly intensive bouts of interaction, and both within WEIRD parental contexts, we defined contingent responses in the current data with slightly generous allowances for overlap and gap: contingent responses must begin with no more than `r allowed.overlap`ms of overlap and `r allowed.gap`ms of gap relative to the offset of the first speaker's turn. We used this same criteria for finding child-to-other turn transitions and other-to-child turn transitions. Transitions were only counted if the other speaker's turn was coded as addressed to 'T' (the target child).

<!--Potentially redefine allowed.overlap and allowed.gap based on ±2.5SD of timing distributions for Hilbrink and Casillas data-->

## Participants

## Material

## Procedure

## Data analysis
<!--We used `r cite_r("r-references.bib")` for all our analyses.-->


# Results
## Still to graph
3: sliding window in random to match mean TDS rate/TT transition rates
4: utt length, repetitiveness, F0 peaks and ranges

## SHOULD I ADD DATAPOINTS ON THE UPH FIGS TO SHOW SHNEIDMAN'S DATA?
Age 1:
- US: CDS 616 (SD=231); ADS/OCDS 278 (SD=247)
-- 79% XDS from MOT (~60% XDS MOT is CDS); 8% XDS from children (mostly ADS/OCDS) 
- Mayan: CDS 86 (SD=59); ADS/OCDS 342 (SD=201)
-- 31% XDS from MOT (~4% XDS MOT is CDS); 60% XDS from children (~50% XDS other kids was ADS/OCDS)
Age18mo?:
Age 2:
- US: CDS M=815, SD=376; ADS/OCDS M=411, SD=318
-- M=65%, SD=28% from MOT (directed: M=800, SD=381; overheard: M=211, SD =55);
-- M=7%, SD=10% from kids (directed: M=15, SD=22; overheard: M=86, SD=141)
- Mayan: CDS M=274, SD=166; ADS/OCDS M=271, SD=136
-- M=19%, SD=17% from MOT (directed:M=104, SD=100; overheard:M=82 SD=52);
-- M=61%, SD=27% from kids (directed:M=104, SD=100; overheard:M=82 SD=52)
Age35mo?

###Observation only data
13 months Directed speech 140 (55); Overheard speech 377 (176)
18 months Directed speech 211 (70); Overheard speech 240 (96)
24 months Directed speech 315 (69); Overheard speech 360 (73)
(I think these data weren't coded for adult vs. child speaker)

<!-- is this right?? the values are the same for D vs. O with adult and kid speech: I think it's more like (directed:M=175, SD=100; overheard:M=190 SD=110) according to figure 2-->


```{r prepare_data, message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
# Read in annotation files
files <- list.files(path=data.path,pattern="*.txt")
all.data <- data.frame()
for (i in 1:length(files)) {
#  print(files[i])
  newfile <- read_csv(paste0(data.path, files[i]), col_types = cols(val = col_character()))
  newfile$aclew_child_id <- unlist(strsplit(files[i], '\\.'))[1]
  all.data <- rbind(all.data, newfile)
}
all.data$row <- c(1:nrow(all.data))

# Read in supplementary data
ptcp.info <- read_csv(ptcp.info.file, col_types = cols()) %>%
  select(-row)
seg.info <- read_csv(seg.index.file)

# Add participant and segment info
codes <- all.data %>% filter(tier == "code")

all.data <- all.data %>%
  filter(speaker != "") %>%
  left_join(ptcp.info, by = "aclew_child_id") %>%
  mutate(segment = "", sample = "",
         sample_type = "", segment_dur = 0)

for (i in 1:nrow(codes)) {
  rec <- codes$aclew_child_id[i]
  seg <- as.character(codes$val[i])
  seg.on <- codes$start[i]
  seg.off <- codes$stop[i]
  seg.idx <- which(all.data$aclew_child_id == rec &
                     all.data$start < seg.off &
                     all.data$stop > seg.on)
  all.data$segment[seg.idx] <- seg
}

# Label samples
all.data$sample[which(
  grepl('^random', all.data$segment))] <- "random"
all.data$sample[which(
  grepl('tt', all.data$segment))] <- "turn-taking"
all.data$sample[which(
  grepl('va', all.data$segment))] <- "high-activity"

# Label sample types and durations
random.samples <- which(grepl('^random', all.data$segment))
all.data$sample_type[random.samples] <- "random"
all.data$segment_dur[random.samples] <- 5

ext.samples <- which(grepl('^extension', all.data$segment))
all.data$sample_type[ext.samples] <- "extension"
all.data$segment_dur[ext.samples] <- 5

tt.samples <- which(grepl('^tt', all.data$segment))
all.data$sample_type[tt.samples] <- "turn-taking"
all.data$segment_dur[tt.samples] <- 1

va.samples <- which(grepl('^va', all.data$segment))
all.data$sample_type[va.samples] <- "turn-taking"
all.data$segment_dur[va.samples] <- 1
```

```{r XDS_TDS_quantity_random, message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
# Get min/hr speech measures
n.unique.rand.segs <- length(unique(all.data$segment[grepl("random", all.data$segment)]))
n.unique.recs <- length(unique(all.data$aclew_child_id))
all.rand.segments <- tibble(
  aclew_child_id = rep(unique(all.data$aclew_child_id),
                n.unique.rand.segs),
  segment = rep(unique(all.data$segment[grepl("random", all.data$segment)]),
                n.unique.recs))
# XDS
xds.per.seg.rand <- all.data %>%
  filter(sample == "random" & speaker != "CHI" &
           grepl("xds@", tier)) %>%
  group_by(aclew_child_id, segment, segment_dur) %>%
  summarise(xds_min = round(sum(dur)/60000,3)) %>%
  full_join(all.rand.segments, by = c("aclew_child_id", "segment")) %>%
  replace_na(list(segment_dur = 5, xds_min = 0)) %>%
  mutate(xds_mph = (xds_min/segment_dur)*60) %>%
  arrange(aclew_child_id, segment)
# TDS
tds.per.seg.rand <- all.data %>%
  filter(sample == "random" & speaker != "CHI" &
           grepl("xds@", tier) & val == "T") %>%
  group_by(aclew_child_id, segment, segment_dur) %>%
  summarise(tds_min = round(sum(dur)/60000,3)) %>%
  full_join(all.rand.segments, by = c("aclew_child_id", "segment")) %>%
  replace_na(list(segment_dur = 5, tds_min = 0)) %>%
  mutate(tds_mph = (tds_min/segment_dur)*60) %>%
  arrange(aclew_child_id, segment)
# All CDS
cds.per.seg.rand <- all.data %>%
  filter(sample == "random" & speaker != "CHI" &
           grepl("xds@", tier) & (val == "T" | val == "C")) %>%
  group_by(aclew_child_id, segment, segment_dur) %>%
  summarise(cds_min = round(sum(dur)/60000,3)) %>%
  full_join(all.rand.segments, by = c("aclew_child_id", "segment")) %>%
  replace_na(list(segment_dur = 5, cds_min = 0)) %>%
  mutate(cds_mph = (cds_min/segment_dur)*60) %>%
  arrange(aclew_child_id, segment)
# All together
quantity.rand <- xds.per.seg.rand %>%
  full_join(tds.per.seg.rand, by = c("aclew_child_id", "segment", "segment_dur")) %>%
  full_join(cds.per.seg.rand, by = c("aclew_child_id", "segment", "segment_dur")) %>%
  full_join(ptcp.info, by = "aclew_child_id") %>%
  replace_na(list(xds_min = 0, xds_mph = 0,
                  tds_min = 0, tds_mph = 0,
                  cds_min = 0, cds_mph = 0)) %>%
  mutate(prop_tds = tds_min/xds_min)
  # Don't replace NAs with 0s in this case; proportion is not meaningful w/o any speech

# Get xds and tds min/hr by speaker type
all.data$SpkrAge <- "Not known"
all.data$SpkrAge[grepl("FA|MA|UA", all.data$speaker)] <- "Adult"
all.data$SpkrAge[grepl("FC|MC|UC", all.data$speaker)] <- "Child"
all.rand.segments.sa <- tibble(
  aclew_child_id = rep(unique(all.data$aclew_child_id),
                2*n.unique.rand.segs),
  segment = rep(unique(all.data$segment[grepl("random", all.data$segment)]),
                2*n.unique.recs),
  SpkrAge = c(rep("Adult", (n.unique.rand.segs * n.unique.recs)),
              rep("Child", (n.unique.rand.segs * n.unique.recs))))
# XDS
xds.per.seg.rand.sa <- all.data %>%
  filter(sample == "random" & speaker != "CHI" & SpkrAge != "Not known" &
           grepl("xds@", tier)) %>%
  group_by(aclew_child_id, SpkrAge, segment, segment_dur) %>%
  summarise(xds_min.sa = round(sum(dur)/60000,3)) %>%
  full_join(all.rand.segments.sa, by = c("aclew_child_id", "segment", "SpkrAge")) %>%
  replace_na(list(segment_dur = 5, xds_min.sa = 0)) %>%
  mutate(xds_mph.sa = (xds_min.sa/segment_dur)*60) %>%
  arrange(aclew_child_id, segment, SpkrAge)
# TDS
tds.per.seg.rand.sa <- all.data %>%
  filter(sample == "random" & speaker != "CHI" & SpkrAge != "Not known" &
           grepl("xds@", tier) & val == "T") %>%
  group_by(aclew_child_id, SpkrAge, segment, segment_dur) %>%
  summarise(tds_min.sa = round(sum(dur)/60000,3)) %>%
  full_join(all.rand.segments.sa, by = c("aclew_child_id", "segment", "SpkrAge")) %>%
  replace_na(list(segment_dur = 5, tds_min.sa = 0)) %>%
  mutate(tds_mph.sa = (tds_min.sa/segment_dur)*60) %>%
  arrange(aclew_child_id, segment, SpkrAge)
# All CDS
cds.per.seg.rand.sa <- all.data %>%
  filter(sample == "random" & speaker != "CHI" & SpkrAge != "Not known" &
           grepl("xds@", tier) & (val == "T" | val == "C")) %>%
  group_by(aclew_child_id, SpkrAge, segment, segment_dur) %>%
  summarise(cds_min.sa = round(sum(dur)/60000,3)) %>%
  full_join(all.rand.segments.sa, by = c("aclew_child_id", "segment", "SpkrAge")) %>%
  replace_na(list(segment_dur = 5, cds_min.sa = 0)) %>%
  mutate(cds_mph.sa = (cds_min.sa/segment_dur)*60) %>%
  arrange(aclew_child_id, segment, SpkrAge)
# All together
quantity.rand.sa <- xds.per.seg.rand.sa %>%
  full_join(tds.per.seg.rand.sa, by = c("aclew_child_id", "SpkrAge",
                                        "segment", "segment_dur")) %>%
  full_join(cds.per.seg.rand.sa, by = c("aclew_child_id", "SpkrAge",
                                        "segment", "segment_dur")) %>%
  full_join(select(quantity.rand, c("aclew_child_id", "segment", "tds_min")),
            by = c("aclew_child_id", "segment")) %>%
  full_join(ptcp.info, by = "aclew_child_id") %>%
  replace_na(list(xds_min.sa = 0, xds_mph.sa = 0,
                  tds_min.sa = 0, tds_mph.sa = 0,
                  cds_min.sa = 0, cds_mph.sa = 0)) %>%
  mutate(prop_tds.sa = tds_min.sa/xds_min.sa,
         prop_sa.tds = tds_min.sa/tds_min)
  # Don't replace NAs with 0s in this case; proportion is not meaningful w/o any speech
```

```{r plot_XDS_TDS_quantity_random, message=FALSE, warning=FALSE, paged.print=FALSE}
# Graph the basic speech quantity info
# XDS min/hr
xdsmph.segments.rand <- ggplot(quantity.rand,
                          aes(x = age_mo_round, y = xds_mph)) +
  geom_boxplot(aes(group = age_mo_round)) +
  geom_smooth(method = "lm", color = "black") +
  ylab("XDS (min/hr)") + xlab("Child age (mo)")	+
  scale_y_continuous(limits=c(0,85),
                     breaks=seq(0,85,20)) +
  scale_x_continuous(limits=c(0,38),
                     breaks=seq(0,38,6)) +
  coord_cartesian(ylim=c(0,85),xlim=c(0,38)) +
  theme_apa()
#xdsmph.segments.rand
# TDS min/hr
tdsmph.segments.rand <- ggplot(quantity.rand,
      aes(x = age_mo_round, y = tds_mph)) +
  geom_boxplot(aes(group = age_mo_round)) +
  geom_smooth(method = "lm", color = "black") +
  ylab("TCDS (min/hr)") + xlab("Child age (mo)")	+
  scale_y_continuous(limits=c(0,85),
                     breaks=seq(0,85,20)) +
  scale_x_continuous(limits=c(0,38),
                     breaks=seq(0,38,6)) +
  coord_cartesian(ylim=c(0,85),xlim=c(0,38)) +
  theme_apa()
#tdsmph.segments.rand
tdsmph.segments.rand.zoomedin <- ggplot(quantity.rand,
                                   aes(x = age_mo_round, y = tds_mph)) +
  geom_boxplot(aes(group = age_mo_round)) +
  geom_smooth(method = "lm", color = "black") +
  ylab("TCDS (min/hr)") + xlab("Child age (mo)")	+
  scale_y_continuous(limits=c(0,40),
                     breaks=seq(0,40,10)) +
  scale_x_continuous(limits=c(0,38),
                     breaks=seq(0,38,6)) +
  coord_cartesian(ylim=c(0,40),xlim=c(0,38)) +
  theme_apa()
#tdsmph.segments.rand.zoomedin
# TDS prop
tdsprp.segments.rand <- ggplot(quantity.rand,
                          aes(x = age_mo_round, y = prop_tds)) +
  geom_boxplot(aes(group = age_mo_round)) +
  geom_smooth(method = "lm", color = "black") +
  ylab("TCDS/XDS") + xlab("Child age (mo)")	+
  scale_y_continuous(limits=c(-.2,1.2),
                     breaks=seq(0,1,0.2)) +
  scale_x_continuous(limits=c(0,38),
                     breaks=seq(0,38,6)) +
  coord_cartesian(ylim=c(0,1),xlim=c(0,38)) +
  theme_apa()
#tdsprp.segments.rand
# prop TDS from adults vs. children
tdsprp.segments.sa.rand <- ggplot(quantity.rand.sa,
                             aes(x = age_mo_round, y = prop_sa.tds,
                                 group = SpkrAge, fill = SpkrAge, color = SpkrAge)) +
  geom_boxplot(aes(group = interaction(age_mo_round, SpkrAge),
                   fill = SpkrAge, color = SpkrAge),
               position = position_dodge(1), alpha = 0.3) +
  geom_smooth(method = "lm") +
  col.sample.bu3 +
  ylab("Prop of TCDS") + xlab("Child age (mo)")	+
  scale_y_continuous(limits=c(-.2,1.2),
                     breaks=seq(0,1,0.2)) +
  scale_x_continuous(limits=c(0,38),
                     breaks=seq(0,38,6)) +
  coord_cartesian(ylim=c(0,1), xlim=c(0,38)) +
  theme_apa() + theme(legend.position="none",
                      axis.line = element_line(color="black", size = 0.4))
#tdsprp.segments.sa.rand
# Combine the plots into one
grid.arrange(xdsmph.segments.rand,tdsmph.segments.rand.zoomedin,
             tdsprp.segments.rand, tdsprp.segments.sa.rand, nrow=2, ncol=2)
```

```{r XDS_TDS_quantity_nonrandom, message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
# Get min/hr speech measures
all.nonrand.segments <- seg.info %>%
  filter(!(grepl("random", CodeName))) %>%
  select(aclew_id, CodeName) %>%
  rename(aclew_child_id = aclew_id, segment = CodeName)
all.nonrand.segments$sample <- ifelse(grepl("va", all.nonrand.segments$segment),
                                      "high-activity","turn-taking")
all.nonrand.segments$sample_type <- ifelse(grepl("^va", all.nonrand.segments$segment),
                                      "high-activity", ifelse(
                                        grepl("^tt", all.nonrand.segments$segment),"turn-taking",
                                        "extension"))
# XDS
xds.per.seg.nonrand <- all.data %>%
  filter(sample != "random" & speaker != "CHI" &
           grepl("xds@", tier)) %>%
  group_by(aclew_child_id, segment, segment_dur) %>%
  summarise(xds_min = round(sum(dur)/60000,3)) %>%
  full_join(all.nonrand.segments, by = c("aclew_child_id", "segment")) %>%
  replace_na(list(segment_dur = 1, xds_min = 0)) %>%
  mutate(segment_dur = ifelse(grepl("ext", segment), 5, 1),
         xds_mph = (xds_min/segment_dur)*60) %>%
  arrange(aclew_child_id, segment)
# TDS
tds.per.seg.nonrand <- all.data %>%
  filter(sample != "random" & speaker != "CHI" &
           grepl("xds@", tier) & val == "T") %>%
  group_by(aclew_child_id, segment, segment_dur) %>%
  summarise(tds_min = round(sum(dur)/60000,3)) %>%
  full_join(all.nonrand.segments, by = c("aclew_child_id", "segment")) %>%
  replace_na(list(segment_dur = 1, tds_min = 0)) %>%
  mutate(segment_dur = ifelse(grepl("ext", segment), 5, 1),
         tds_mph = (tds_min/segment_dur)*60) %>%
  arrange(aclew_child_id, segment)
# All CDS
cds.per.seg.nonrand <- all.data %>%
  filter(sample != "random" & speaker != "CHI" &
           grepl("xds@", tier) & (val == "T" | val == "C")) %>%
  group_by(aclew_child_id, segment, segment_dur) %>%
  summarise(cds_min = round(sum(dur)/60000,3)) %>%
  full_join(all.nonrand.segments, by = c("aclew_child_id", "segment")) %>%
  replace_na(list(segment_dur = 1, cds_min = 0)) %>%
  mutate(segment_dur = ifelse(grepl("ext", segment), 5, 1),
         cds_mph = (cds_min/segment_dur)*60) %>%
  arrange(aclew_child_id, segment)
# All together
quantity.nonrand <- xds.per.seg.nonrand %>%
  full_join(tds.per.seg.nonrand, by = c("aclew_child_id", "segment",
                                        "segment_dur", "sample", "sample_type")) %>%
  full_join(cds.per.seg.nonrand, by = c("aclew_child_id", "segment",
                                        "segment_dur", "sample", "sample_type")) %>%
  full_join(ptcp.info, by = "aclew_child_id") %>%
  replace_na(list(xds_min = 0, xds_mph = 0,
                  tds_min = 0, tds_mph = 0,
                  cds_min = 0, cds_mph = 0)) %>%
  mutate(prop_tds = tds_min/xds_min)
  # Don't replace NAs with 0s in this case; proportion is not meaningful w/o any speech

# Get xds and tds min/hr by speaker type
all.nonrand.segments.sa <- tibble(
  aclew_child_id = rep(all.nonrand.segments$aclew_child_id, 2),
  segment = rep(all.nonrand.segments$segment, 2),
  sample = rep(all.nonrand.segments$sample, 2),
  sample_type = rep(all.nonrand.segments$sample_type, 2),
  SpkrAge = c(rep("Adult", nrow(all.nonrand.segments)),
              rep("Child", nrow(all.nonrand.segments))))
# XDS
xds.per.seg.nonrand.sa <- all.data %>%
  filter(sample != "random" & speaker != "CHI" & SpkrAge != "Not known" &
           grepl("xds@", tier)) %>%
  group_by(aclew_child_id, SpkrAge, segment, segment_dur) %>%
  summarise(xds_min.sa = round(sum(dur)/60000,3)) %>%
  full_join(all.nonrand.segments.sa, by = c("aclew_child_id", "segment", "SpkrAge")) %>%
  replace_na(list(segment_dur = 1, xds_min.sa = 0)) %>%
  mutate(segment_dur = ifelse(grepl("ext", segment), 5, 1),
         xds_mph.sa = (xds_min.sa/segment_dur)*60) %>%
  arrange(aclew_child_id, segment, SpkrAge)
# TDS
tds.per.seg.nonrand.sa <- all.data %>%
  filter(sample != "random" & speaker != "CHI" & SpkrAge != "Not known" &
           grepl("xds@", tier) & val == "T") %>%
  group_by(aclew_child_id, SpkrAge, segment, segment_dur) %>%
  summarise(tds_min.sa = round(sum(dur)/60000,3)) %>%
  full_join(all.nonrand.segments.sa, by = c("aclew_child_id", "segment", "SpkrAge")) %>%
  replace_na(list(segment_dur = 1, tds_min.sa = 0)) %>%
  mutate(segment_dur = ifelse(grepl("ext", segment), 5, 1),
         tds_mph.sa = (tds_min.sa/segment_dur)*60) %>%
  arrange(aclew_child_id, segment, SpkrAge)
# All CDS
cds.per.seg.nonrand.sa <- all.data %>%
  filter(sample != "random" & speaker != "CHI" & SpkrAge != "Not known" &
           grepl("xds@", tier) & (val == "T" | val == "C")) %>%
  group_by(aclew_child_id, SpkrAge, segment, segment_dur) %>%
  summarise(cds_min.sa = round(sum(dur)/60000,3)) %>%
  full_join(all.nonrand.segments.sa, by = c("aclew_child_id", "segment", "SpkrAge")) %>%
  replace_na(list(segment_dur = 1, cds_min.sa = 0)) %>%
  mutate(segment_dur = ifelse(grepl("ext", segment), 5, 1),
         cds_mph.sa = (cds_min.sa/segment_dur)*60) %>%
  arrange(aclew_child_id, segment, SpkrAge)
# All together
quantity.nonrand.sa <- xds.per.seg.nonrand.sa %>%
  full_join(tds.per.seg.nonrand.sa, by = c("aclew_child_id", "SpkrAge",
                                           "segment", "segment_dur",
                                           "sample", "sample_type")) %>%
  full_join(cds.per.seg.nonrand.sa, by = c("aclew_child_id", "SpkrAge",
                                           "segment", "segment_dur",
                                           "sample", "sample_type")) %>%
  full_join(select(quantity.nonrand, c("aclew_child_id", "segment", "tds_min")),
            by = c("aclew_child_id", "segment")) %>%
  full_join(ptcp.info, by = "aclew_child_id") %>%
  replace_na(list(xds_min.sa = 0, xds_mph.sa = 0,
                  tds_min.sa = 0, tds_mph.sa = 0,
                  cds_min.sa = 0, cds_mph.sa = 0)) %>%
  mutate(prop_tds.sa = tds_min.sa/xds_min.sa,
         prop_sa.tds = tds_min.sa/tds_min)
  # Don't replace NAs with 0s in this case; proportion is not meaningful w/o any speech
```

```{r plot_XDS_TDS_quantity_nonrandom, message=FALSE, warning=FALSE, paged.print=FALSE}
# Graph the basic speech quantity info
# XDS min/hr
xdsmph.segments.nonrand <- ggplot(quantity.nonrand,
                          aes(x = age_mo_round, y = xds_mph,
                              group = sample, fill = sample, color = sample)) +
  geom_boxplot(aes(group = interaction(age_mo_round, sample),
               fill = sample, color = sample),
               position = position_dodge(1), alpha = 0.3) +
  geom_smooth(aes(lty = sample), method = "lm") +
  scale_fill_manual(values=c("gray60", "gray20")) +
  scale_color_manual(values=c("gray60", "gray20")) +
  scale_linetype_manual(values=c("solid", "dashed")) +
  ylab("XDS (min/hr)") + xlab("Child age (mo)")	+
  scale_y_continuous(limits=c(0,85),
                     breaks=seq(0,85,20)) +
  scale_x_continuous(limits=c(0,38),
                     breaks=seq(0,38,6)) +
  coord_cartesian(ylim=c(0,85),xlim=c(0,38)) +
  theme_apa() + theme(legend.position="none",
                      axis.line = element_line(color="black", size = 0.4))
# xdsmph.segments.nonrand
# TDS min/hr
tdsmph.segments.nonrand <- ggplot(quantity.nonrand,
                          aes(x = age_mo_round, y = tds_mph,
                              group = sample, fill = sample, color = sample)) +
  geom_boxplot(aes(group = interaction(age_mo_round, sample),
               fill = sample, color = sample),
               position = position_dodge(1), alpha = 0.3) +
  geom_smooth(aes(lty = sample), method = "lm") +
  scale_fill_manual(values=c("gray60", "gray20")) +
  scale_color_manual(values=c("gray60", "gray20")) +
  scale_linetype_manual(values=c("solid", "dashed")) +
  ylab("TCDS (min/hr)") + xlab("Child age (mo)")	+
  scale_y_continuous(limits=c(0,85),
                     breaks=seq(0,85,20)) +
  scale_x_continuous(limits=c(0,38),
                     breaks=seq(0,38,6)) +
  coord_cartesian(ylim=c(0,85),xlim=c(0,38)) +
  theme_apa() + theme(legend.position="none",
                      axis.line = element_line(color="black", size = 0.4))
#tdsmph.segments.nonrand
tdsmph.segments.nonrand.zoomedin <- ggplot(quantity.nonrand,
                          aes(x = age_mo_round, y = tds_mph,
                              group = sample, fill = sample, color = sample)) +
  geom_boxplot(aes(group = interaction(age_mo_round, sample),
               fill = sample, color = sample),
               position = position_dodge(1), alpha = 0.3) +
  geom_smooth(aes(lty = sample), method = "lm") +
  scale_fill_manual(values=c("gray60", "gray20")) +
  scale_color_manual(values=c("gray60", "gray20")) +
  scale_linetype_manual(values=c("solid", "dashed")) +
  ylab("TCDS (min/hr)") + xlab("Child age (mo)")	+
  scale_y_continuous(limits=c(0,40),
                     breaks=seq(0,40,10)) +
  scale_x_continuous(limits=c(0,38),
                     breaks=seq(0,38,6)) +
  coord_cartesian(ylim=c(0,40),xlim=c(0,38)) +
  theme_apa() + theme(legend.position="none",
                      axis.line = element_line(color="black", size = 0.4))
#tdsmph.segments.nonrand.zoomedin
# TDS prop
tdsprp.segments.nonrand <- ggplot(quantity.nonrand,
                          aes(x = age_mo_round, y = prop_tds,
                              group = sample, fill = sample, color = sample)) +
  geom_boxplot(aes(group = interaction(age_mo_round, sample),
               fill = sample, color = sample),
               position = position_dodge(1), alpha = 0.3) +
  geom_smooth(aes(lty = sample), method = "lm") +
  scale_fill_manual(values=c("gray60", "gray20")) +
  scale_color_manual(values=c("gray60", "gray20")) +
  scale_linetype_manual(values=c("solid", "dashed")) +
  ylab("TCDS/XDS") + xlab("Child age (mo)")	+
  scale_y_continuous(limits=c(-.2,1.2),
                     breaks=seq(0,1,0.2)) +
  scale_x_continuous(limits=c(0,38),
                     breaks=seq(0,38,6)) +
  coord_cartesian(ylim=c(0,1),xlim=c(0,38)) +
  theme_apa() + theme(legend.position="none",
                      axis.line = element_line(color="black", size = 0.4))
#tdsprp.segments.nonrand
# prop TDS from adults vs. children
tdsprp.segments.sa.nonrand <- ggplot(quantity.nonrand.sa,
                             aes(x = age_mo_round, y = prop_sa.tds,
                                 group = SpkrAge, fill = SpkrAge)) +
  geom_boxplot(aes(group = interaction(age_mo_round, SpkrAge, sample),
                  color = interaction(SpkrAge, sample),
                  fill = interaction(SpkrAge, sample)),
               position = position_dodge(3), alpha = 0.3, lwd = 0.2) +
  geom_smooth(aes(group = interaction(SpkrAge, sample),
                  color = interaction(SpkrAge, sample),
                  fill = interaction(SpkrAge, sample),
                  lty = interaction(SpkrAge, sample)),
              method = "lm", alpha = 0.2) +
  scale_fill_manual(values=c(viridis(3)[1], viridis(3)[2],
                             viridis(3)[1], viridis(3)[2])) +
  scale_color_manual(values=c(viridis(3)[1], viridis(3)[2],
                             viridis(3)[1], viridis(3)[2])) +
  scale_linetype_manual(values=c("solid", "solid", "dashed", "dashed")) +
  ylab("Prop of TCDS") + xlab("Child age (mo)")	+
  scale_y_continuous(limits=c(-.2,1.2),
                     breaks=seq(0,1,0.2)) +
  scale_x_continuous(limits=c(0,38),
                     breaks=seq(0,38,6)) +
  coord_cartesian(ylim=c(0,1), xlim=c(0,38)) +
  theme_apa() + theme(legend.position="none",
                      axis.line = element_line(color="black", size = 0.4))
#tdsprp.segments.sa.nonrand
# Combine the plots into one
grid.arrange(xdsmph.segments.nonrand, tdsmph.segments.nonrand.zoomedin,
             tdsprp.segments.nonrand, tdsprp.segments.sa.nonrand, nrow=2, ncol=2)
```


``` {r chi_voctypes_overall}
chi.vm.lx.utts <- all.data %>%
  filter((tier == "vcm@CHI" | tier == "lex@CHI" | tier == "mwu@CHI")) %>%
  mutate(voc.rating = ifelse(val == "M", 4,
                             ifelse((val == "1" | val == "W"), 3,
                                    ifelse((val == "0" | val == "C"), 2,
                                           ifelse(val == "N", 1, 0))))) %>%
  filter(voc.rating > 0) %>%
  group_by(aclew_child_id, segment, sample, start) %>%
  summarise(max_voc.rtg = max(voc.rating))

all.voc.types.per.child <- tibble(
  aclew_child_id = rep(ptcp.info$aclew_child_id, 4),
  max_voc.rtg = c(rep(1, length(ptcp.info$aclew_child_id)), rep(2, length(ptcp.info$aclew_child_id)),
                  rep(3, length(ptcp.info$aclew_child_id)), rep(4, length(ptcp.info$aclew_child_id)))
)

chi.nvocs <- chi.vm.lx.utts %>%
  group_by(aclew_child_id) %>%
  summarise(n_vocs = n())

chi.vm.lx.voc.type.props <- chi.vm.lx.utts %>%
  group_by(aclew_child_id, max_voc.rtg) %>%
  summarise(n_voc.type = n()) %>%
  full_join(all.voc.types.per.child, by = c("aclew_child_id", "max_voc.rtg")) %>%
  replace_na(list(n_voc.type = 0)) %>%
  full_join(chi.nvocs, by = "aclew_child_id") %>%
  mutate(prop_voc.type = round(n_voc.type/n_vocs, 3)) %>%
  arrange(aclew_child_id, max_voc.rtg) %>%
  full_join(ptcp.info, by = "aclew_child_id")
```


``` {r plot_chi_voctypes_overall}
chi.vm.lx.voc.type.props <- chi.vm.lx.voc.type.props %>%
  mutate(voc.type = factor(as.factor(max_voc.rtg), labels = c("NCB", "CB", "SW", "MW")))
voc.mat.by.age <- ggplot(
  data = chi.vm.lx.voc.type.props,
  aes(x = age_mo_round, y = prop_voc.type, group = as.factor(voc.type))) +
  geom_point(aes(color = as.factor(voc.type))) +
  geom_smooth(aes(color = as.factor(voc.type), fill = as.factor(voc.type)), method = "loess") +
  ylab("Prop of linguistic vocs") + xlab("Child age (mo)") +
  labs(fill='Voc type') +
  labs(color='Voc type') +
  scale_y_continuous(limits=c(-0.5,1.5),
                     breaks=seq(0,1,0.2)) +
  scale_x_continuous(limits=c(0,38),
                     breaks=seq(0,38,6)) +
  coord_cartesian(ylim=c(0,1), xlim=c(0,38)) +
  theme_apa() + theme(
    legend.position = c(0.9, 0.85),
    legend.background = element_rect(fill="transparent"),
    axis.line = element_line(color="black", size = 0.4))
voc.mat.by.age
```


``` {r sample_differences}
# deltas m/h XDS, TDS, and CDS mph
quantity.mph.per.sample <- quantity.rand %>%
  mutate(sample = "random",
         sample_type = "random") %>%
  bind_rows(quantity.nonrand) %>%
  group_by(aclew_child_id, sample) %>%
  summarise(m_xds_mph = mean(xds_mph),
         m_tds_mph = mean(tds_mph),
         m_cds_mph = mean(cds_mph))
deltas.random.v.tt <- quantity.mph.per.sample %>%
  filter(sample != "high-activity") %>%
  arrange(aclew_child_id, sample) %>%
  mutate(d_xds_mph = 0,
         d_tds_mph = 0,
         d_cds_mph = 0)
for (i in 2:nrow(deltas.random.v.tt)) {
  deltas.random.v.tt$d_xds_mph[i] <-
    deltas.random.v.tt$m_xds_mph[i] -
    deltas.random.v.tt$m_xds_mph[i-1] # set up for tt - random
  deltas.random.v.tt$d_tds_mph[i] <-
    deltas.random.v.tt$m_tds_mph[i] - deltas.random.v.tt$m_tds_mph[i-1]
  deltas.random.v.tt$d_cds_mph[i] <-
    deltas.random.v.tt$m_cds_mph[i] - deltas.random.v.tt$m_cds_mph[i-1]
}
deltas.random.v.tt <- deltas.random.v.tt %>%
  filter(sample != "random") %>% # only keep meaningful vals
  select(aclew_child_id, d_xds_mph, d_tds_mph, d_cds_mph) %>%
  mutate(delta = "tt-random")
deltas.random.v.va <- quantity.mph.per.sample %>%
  filter(sample != "turn-taking") %>%
  arrange(aclew_child_id, sample) %>%
  mutate(d_xds_mph = 0,
         d_tds_mph = 0,
         d_cds_mph = 0)
for (i in 2:nrow(deltas.random.v.va)) {
  deltas.random.v.va$d_xds_mph[i] <-
    deltas.random.v.va$m_xds_mph[i-1] -
    deltas.random.v.va$m_xds_mph[i] # set up for va - random
  deltas.random.v.va$d_tds_mph[i] <-
    deltas.random.v.va$m_tds_mph[i-1] - deltas.random.v.va$m_tds_mph[i]
  deltas.random.v.va$d_cds_mph[i] <-
    deltas.random.v.va$m_cds_mph[i-1] - deltas.random.v.va$m_cds_mph[i]
}
deltas.random.v.va <- deltas.random.v.va %>%
  filter(sample == "random") %>% # only keep meaningful vals
  select(aclew_child_id, d_xds_mph, d_tds_mph, d_cds_mph) %>%
  mutate(delta = "va-random")
deltas.random.v.oth <- bind_rows(deltas.random.v.tt, deltas.random.v.va) %>%
  full_join(ptcp.info, by = "aclew_child_id")

# deltas utt/h XDS, TDS, and CDS
tot.dur.samples.per.rec <- seg.info %>%
  mutate(duration = ifelse(grepl('1min', Sample), 1, 5),
         sample = ifelse(grepl('random', CodeName), "random",
                         ifelse(grepl('va', CodeName), "high-activity",
                                "turn-taking"))) %>%
  select(aclew_id, CodeName, duration, sample) %>%
  rename(aclew_child_id = aclew_id, segment = CodeName)
n.utts.per.sample.all <- all.data %>%
  filter(speaker != "CHI" & grepl("xds@", tier)) %>%
  group_by(aclew_child_id, segment, val) %>%
  summarise(n_utts = n()) %>%
  full_join(tot.dur.samples.per.rec, by = c("aclew_child_id", "segment")) %>%
  replace_na(list(val = "T", n_utts = 0))
n.utts.per.sample.xds <- n.utts.per.sample.all %>%
  group_by(aclew_child_id, segment, sample, duration) %>%
  summarise(n_utts_seg = sum(n_utts)) %>%
  mutate(xds_uph = (n_utts_seg/duration)*60) %>%
  group_by(aclew_child_id, sample) %>%
  summarise(m_xds_uph = mean(xds_uph))
n.utts.per.sample.tds <- n.utts.per.sample.all %>%
  filter(val == "T") %>%
  group_by(aclew_child_id, segment, sample, duration) %>%
  summarise(n_utts_seg = sum(n_utts)) %>%
  mutate(tds_uph = (n_utts_seg/duration)*60) %>%
  group_by(aclew_child_id, sample) %>%
  summarise(m_tds_uph = mean(tds_uph))
n.utts.per.sample.cds <- n.utts.per.sample.all %>%
  filter(val == "T" | val == "C") %>%
  group_by(aclew_child_id, segment, sample, duration) %>%
  summarise(n_utts_seg = sum(n_utts)) %>%
  mutate(cds_uph = (n_utts_seg/duration)*60) %>%
  group_by(aclew_child_id, sample) %>%
  summarise(m_cds_uph = mean(cds_uph))
uph.per.sample <- n.utts.per.sample.xds %>%
  full_join(n.utts.per.sample.tds, by = c("aclew_child_id", "sample")) %>%
  full_join(n.utts.per.sample.cds, by = c("aclew_child_id", "sample"))
deltas.random.v.tt.uph <- uph.per.sample %>%
  filter(sample != "high-activity") %>%
  mutate(d_xds_uph = 0,
         d_tds_uph = 0,
         d_cds_uph = 0) %>%
  arrange(aclew_child_id, sample)
for (i in 2:nrow(deltas.random.v.tt.uph)) {
  deltas.random.v.tt.uph$d_xds_uph[i] <-
    deltas.random.v.tt.uph$m_xds_uph[i] - deltas.random.v.tt.uph$m_xds_uph[i-1]
  deltas.random.v.tt.uph$d_tds_uph[i] <-
    deltas.random.v.tt.uph$m_tds_uph[i] - deltas.random.v.tt.uph$m_tds_uph[i-1]
  deltas.random.v.tt.uph$d_cds_uph[i] <-
    deltas.random.v.tt.uph$m_cds_uph[i] - deltas.random.v.tt.uph$m_cds_uph[i-1]
}
deltas.random.v.tt.uph <- deltas.random.v.tt.uph %>%
  filter(sample != "random") %>%
  select(aclew_child_id, d_xds_uph, d_tds_uph, d_cds_uph) %>%
  mutate(delta = "tt-random")
deltas.random.v.va.uph <- uph.per.sample %>%
  filter(sample != "turn-taking") %>%
  mutate(d_xds_uph = 0,
         d_tds_uph = 0,
         d_cds_uph = 0) %>%
  arrange(aclew_child_id, sample)
for (i in 2:nrow(deltas.random.v.va.uph)) {
  deltas.random.v.va.uph$d_xds_uph[i] <-
    deltas.random.v.va.uph$m_xds_uph[i-1] - deltas.random.v.va.uph$m_xds_uph[i]
  deltas.random.v.va.uph$d_tds_uph[i] <-
    deltas.random.v.va.uph$m_tds_uph[i-1] - deltas.random.v.va.uph$m_tds_uph[i]
  deltas.random.v.va.uph$d_cds_uph[i] <-
    deltas.random.v.va.uph$m_cds_uph[i-1] - deltas.random.v.va.uph$m_cds_uph[i]
}
deltas.random.v.va.uph <- deltas.random.v.va.uph %>%
  filter(sample == "random") %>%
  select(aclew_child_id, d_xds_uph, d_tds_uph, d_cds_uph) %>%
  mutate(delta = "va-random")
deltas.random.v.oth.utts <- bind_rows(deltas.random.v.tt.uph, deltas.random.v.va.uph) %>%
  full_join(ptcp.info, by = "aclew_child_id")

# TT transitions
all.segments <- all.rand.segments %>%
  mutate(sample = "random", sample_type = "random") %>%
  bind_rows(all.nonrand.segments) %>%
  arrange(aclew_child_id, segment)
turn.transitions <- tibble(
  aclew_child_id = NA,
  segment = NA,
  tier = NA,
  speaker = NA,
  start = NA,
  stop = NA,
  tm1.tier = NA,
  tm1.speaker = NA,
  tm1.start = NA,
  tm1.stop = NA,
  tm1.val = NA,
  tp1.tier = NA,
  tp1.speaker = NA,
  tp1.start = NA,
  tp1.stop = NA,
  tp1.val = NA
)
for (i in 1:nrow(all.segments)) {
  subdata <- all.data %>%
    filter(aclew_child_id == all.segments$aclew_child_id[i] &
             segment == all.segments$segment[i])
  c_utt <- subdata %>%
    filter(tier == "CHI")
  used.tm1s <- c()
  used.tp1s <- c()
  child <- all.segments$aclew_child_id[i]
  # Save turn-by-turn info
  chi.turn.info <- c_utt %>%
    select(aclew_child_id, segment, tier, speaker, start, stop) %>%
    mutate(tm1.tier = NA, tm1.speaker = NA, tm1.start = NA, tm1.stop = NA, tm1.val = NA,
           tp1.tier = NA, tp1.speaker = NA, tp1.start = NA, tp1.stop = NA, tp1.val = NA)
  for (j in 1:nrow(c_utt)) {
    # Find CHI-OTH transitions
    tp1.start <- c_utt$stop[j] - allowed.overlap
    tp1.stop <- tp1.start + allowed.overlap + allowed.gap
    t.plus1 <- which(subdata$speaker != "CHI" &
                    (subdata$val == "T"|subdata$val == "C") &
                    subdata$start >= tp1.start &
                    subdata$start <= tp1.stop)
   # Find OTH-CHI transitions
    tm1.start <- c_utt$start[j] - allowed.gap
    tm1.stop <- tm1.start + allowed.gap + allowed.overlap
    t.minus1 <- which(subdata$speaker != "CHI" &
                    (subdata$val == "T"|subdata$val == "C") &
                    subdata$stop <= tm1.stop &
                    subdata$stop >= tm1.start)
    if(length(t.plus1) > 0) {
      tp1.match <- 0
      for (turn in t.plus1) {
        if (!(turn %in% used.tp1s) & tp1.match == 0) {
          used.tp1s <- c(used.tp1s, turn)
          chi.turn.info$tp1.tier[j] <- subdata$tier[turn]
          chi.turn.info$tp1.speaker[j] <- subdata$speaker[turn]
          chi.turn.info$tp1.start[j] <- subdata$start[turn]
          chi.turn.info$tp1.stop[j] <- subdata$stop[turn]
          chi.turn.info$tp1.val[j] <- subdata$val[turn]
          tp1.match <- 1
        }
      }
    }
    if(length(t.minus1) > 0) {
      tm1.match <- 0
      for (turn in t.minus1) {
        if (!(turn %in% used.tm1s) & tm1.match == 0) {
          used.tm1s <- c(used.tm1s, turn)
          chi.turn.info$tm1.tier[j] <- subdata$tier[turn]
          chi.turn.info$tm1.speaker[j] <- subdata$speaker[turn]
          chi.turn.info$tm1.start[j] <- subdata$start[turn]
          chi.turn.info$tm1.stop[j] <- subdata$stop[turn]
          chi.turn.info$tm1.val[j] <- subdata$val[turn]
          tm1.match <- 1
        }
      }
    }
  }
  turn.transitions <- bind_rows(turn.transitions, chi.turn.info)
}
turn.transitions <- turn.transitions %>%
  filter(!(is.na(tier)))
turn.transitions.overview.o_c <- turn.transitions %>%
  group_by(aclew_child_id, segment, tm1.val) %>%
  summarise(n.o_c.tts = n()) %>%
  rename(oth.spkr = tm1.val) %>%
  replace_na(list(oth.spkr = "O"))
turn.transitions.overview.c_o <- turn.transitions %>%
  group_by(aclew_child_id, segment, tp1.val) %>%
  summarise(n.c_o.tts = n()) %>%
  rename(oth.spkr = tp1.val) %>%
  replace_na(list(oth.spkr = "O"))
all.tt.combos <-  all.segments %>%
  rbind(all.segments) %>%
  rbind(all.segments) %>%
  mutate(oth.spkr = c(rep("T", nrow(all.segments)),
                      rep("C", nrow(all.segments)),
                      rep("O", nrow(all.segments))),
         duration = ifelse(grepl('extension', sample_type), 5,
                           ifelse(grepl('random', sample_type), 5, 1))) %>%
  arrange(aclew_child_id, segment, oth.spkr) %>%
  full_join(turn.transitions.overview.o_c,
            by = c("aclew_child_id", "segment", "oth.spkr")) %>%
  full_join(turn.transitions.overview.c_o,
            by = c("aclew_child_id", "segment", "oth.spkr")) %>%
  replace_na(list(n.o_c.tts = 0, n.c_o.tts = 0)) %>%
  arrange(aclew_child_id, segment, oth.spkr)
tth.per.sample.tds <- all.tt.combos %>%
  filter(oth.spkr == "T") %>%
  group_by(aclew_child_id, sample) %>%
  summarise(dur.sample = sum(duration),
            S.o_c.tth.tds = sum(n.o_c.tts),
            S.c_o.tth.tds = sum(n.c_o.tts)) %>%
  mutate(o_c.tth.tds = (S.o_c.tth.tds/dur.sample)*60,
         c_o.tth.tds = (S.c_o.tth.tds/dur.sample)*60)
tth.per.sample.cds <- all.tt.combos %>%
  filter(oth.spkr == "T" | oth.spkr == "C") %>%
  group_by(aclew_child_id, segment, sample, duration) %>%
  summarise(n_o_c.tts.TC = sum(n.o_c.tts),
            n_c_o.tts.TC = sum(n.c_o.tts)) %>%
  ungroup() %>%
  group_by(aclew_child_id, sample) %>%
  summarise(dur.sample = sum(duration),
            S.o_c.tth.cds = sum(n_o_c.tts.TC),
            S.c_o.tth.cds = sum(n_c_o.tts.TC)) %>%
  mutate(o_c.tth.cds = (S.o_c.tth.cds/dur.sample)*60,
         c_o.tth.cds = (S.c_o.tth.cds/dur.sample)*60)
tth.per.sample <- tth.per.sample.tds %>%
  select(-dur.sample) %>%
  full_join(tth.per.sample.cds, by = c("aclew_child_id", "sample")) %>%
  arrange(aclew_child_id, sample) %>%
  mutate(d_o_c.tth.tds = 0,
         d_c_o.tth.tds = 0,
         d_o_c.tth.cds = 0,
         d_c_o.tth.cds = 0)
deltas.random.v.tt.tth <- tth.per.sample %>%
  filter(sample != "high-activity")
for (i in 2:nrow(deltas.random.v.tt.tth)) {
  deltas.random.v.tt.tth$d_o_c.tth.tds[i] <-
    deltas.random.v.tt.tth$o_c.tth.tds[i] -
    deltas.random.v.tt.tth$o_c.tth.tds[i-1] # set up for tt - random
  deltas.random.v.tt.tth$d_c_o.tth.tds[i] <-
    deltas.random.v.tt.tth$c_o.tth.tds[i] - deltas.random.v.tt.tth$c_o.tth.tds[i-1]
  deltas.random.v.tt.tth$d_o_c.tth.cds[i] <-
    deltas.random.v.tt.tth$o_c.tth.cds[i] -
    deltas.random.v.tt.tth$o_c.tth.cds[i-1]
  deltas.random.v.tt.tth$d_c_o.tth.cds[i] <-
    deltas.random.v.tt.tth$c_o.tth.cds[i] - deltas.random.v.tt.tth$c_o.tth.cds[i-1]
}
deltas.random.v.tt.tth <- deltas.random.v.tt.tth %>%
  filter(sample != "random") %>% # only keep meaningful vals
  ungroup() %>%
  select(aclew_child_id, d_o_c.tth.tds, d_c_o.tth.tds, d_o_c.tth.cds, d_c_o.tth.cds) %>%
  mutate(delta = "tt-random")
deltas.random.v.ha.tth <- tth.per.sample %>%
  filter(sample != "turn-taking")
for (i in 2:nrow(deltas.random.v.ha.tth)) {
  deltas.random.v.ha.tth$d_o_c.tth.tds[i] <-
    deltas.random.v.ha.tth$o_c.tth.tds[i-1] -
    deltas.random.v.ha.tth$o_c.tth.tds[i] # set up for ha - random
  deltas.random.v.ha.tth$d_c_o.tth.tds[i] <-
    deltas.random.v.ha.tth$c_o.tth.tds[i-1] - deltas.random.v.ha.tth$c_o.tth.tds[i]
  deltas.random.v.ha.tth$d_o_c.tth.cds[i] <-
    deltas.random.v.ha.tth$o_c.tth.cds[i-1] -
    deltas.random.v.ha.tth$o_c.tth.cds[i]
  deltas.random.v.ha.tth$d_c_o.tth.cds[i] <-
    deltas.random.v.ha.tth$c_o.tth.cds[i-1] - deltas.random.v.ha.tth$c_o.tth.cds[i]
}
deltas.random.v.ha.tth <- deltas.random.v.ha.tth %>%
  filter(sample == "random") %>% # only keep meaningful vals
  ungroup() %>%
  select(aclew_child_id, d_o_c.tth.tds, d_c_o.tth.tds, d_o_c.tth.cds, d_c_o.tth.cds) %>%
  mutate(delta = "va-random")
deltas.random.v.oth.tth <- deltas.random.v.tt.tth %>%
  bind_rows(deltas.random.v.ha.tth) %>%
  full_join(ptcp.info, by = "aclew_child_id")

# CHIVOC mph and uph
chi.voc <- all.data %>%
  filter(tier == "CHI") %>%
  group_by(aclew_child_id, segment) %>%
  summarise(n_utts = n(),
            dur.utts = round(sum(dur)/60000,3)) %>%
  full_join(all.segments, by = c("aclew_child_id", "segment")) %>%
  replace_na(list(n_utts = 0, dur.utts = 0)) %>%
  mutate(duration = ifelse(grepl('extension', segment), 5,
                                 ifelse(grepl('random', segment), 5, 1)))
chi.voc.per.sample <- chi.voc %>%
  group_by(aclew_child_id, sample) %>%
  summarise(S_n_utts = sum(n_utts),
            S_dur.utts = sum(dur.utts),
            S_duration = sum(duration)) %>%
  mutate(cvc_uph = (S_n_utts/S_duration)*60,
         cvc_mph = (S_dur.utts/S_duration)*60) %>%
  select(-S_n_utts, -S_dur.utts, -S_duration) %>%
  arrange(aclew_child_id, sample) %>%
  mutate(d_cvc_uph = 0,
         d_cvc_mph = 0)
deltas.random.v.tt.cvc <- chi.voc.per.sample %>%
  filter(sample != "high-activity")
for (i in 2:nrow(deltas.random.v.tt.cvc)) {
  deltas.random.v.tt.cvc$d_cvc_uph[i] <-
    deltas.random.v.tt.cvc$cvc_uph[i] -
    deltas.random.v.tt.cvc$cvc_uph[i-1] # set up for tt - random
  deltas.random.v.tt.cvc$d_cvc_mph[i] <-
    deltas.random.v.tt.cvc$cvc_mph[i] - deltas.random.v.tt.cvc$cvc_mph[i-1]
}
deltas.random.v.tt.cvc <- deltas.random.v.tt.cvc %>%
  filter(sample != "random") %>% # only keep meaningful vals
  ungroup() %>%
  select(aclew_child_id, d_cvc_uph, d_cvc_mph) %>%
  mutate(delta = "tt-random")
deltas.random.v.ha.cvc <- chi.voc.per.sample %>%
  filter(sample != "turn-taking")
for (i in 2:nrow(deltas.random.v.ha.cvc)) {
  deltas.random.v.ha.cvc$d_cvc_uph[i] <-
    deltas.random.v.ha.cvc$cvc_uph[i-1] -
    deltas.random.v.ha.cvc$cvc_uph[i] # set up for ha - random
  deltas.random.v.ha.cvc$d_cvc_mph[i] <-
    deltas.random.v.ha.cvc$cvc_mph[i-1] - deltas.random.v.ha.cvc$cvc_mph[i]
}
deltas.random.v.ha.cvc <- deltas.random.v.ha.cvc %>%
  filter(sample == "random") %>% # only keep meaningful vals
  ungroup() %>%
  select(aclew_child_id, d_cvc_uph, d_cvc_mph) %>%
  mutate(delta = "va-random")
deltas.random.v.oth.cvc <- deltas.random.v.tt.cvc %>%
  bind_rows(deltas.random.v.ha.cvc) %>%
  full_join(ptcp.info, by = "aclew_child_id")

# CHIVM
chi.vm.lx.per.segment <- chi.vm.lx.utts %>%
  group_by(aclew_child_id, sample, segment) %>%
  summarise(n_vocs = n(),
            m_voc.rtg = mean(max_voc.rtg),
            md_voc.rtg = median(max_voc.rtg),
            sd_voc.rtg = sd(max_voc.rtg)) %>%
  full_join(ptcp.info, by = c("aclew_child_id"))
chi.vm.lx.per.sample <- chi.vm.lx.per.segment %>%
  group_by(aclew_child_id, sample) %>%
  summarise(voc_rtg = mean(m_voc.rtg)) %>%
  arrange(aclew_child_id, sample) %>%
  mutate(d_voc_rtg = 0)
deltas.random.v.tt.vrt <- chi.vm.lx.per.sample %>%
  filter(sample != "high-activity")
for (i in 2:nrow(deltas.random.v.tt.vrt)) {
  deltas.random.v.tt.vrt$d_voc_rtg[i] <-
    deltas.random.v.tt.vrt$voc_rtg[i] -
    deltas.random.v.tt.vrt$voc_rtg[i-1] # set up for tt - random
}
deltas.random.v.tt.vrt <- deltas.random.v.tt.vrt %>%
  filter(sample != "random") %>% # only keep meaningful vals
  ungroup() %>%
  select(aclew_child_id, d_voc_rtg) %>%
  mutate(delta = "tt-random")
deltas.random.v.ha.vrt <- chi.vm.lx.per.sample %>%
  filter(sample != "turn-taking")
for (i in 2:nrow(deltas.random.v.ha.vrt)) {
  deltas.random.v.ha.vrt$d_voc_rtg[i] <-
    deltas.random.v.ha.vrt$voc_rtg[i-1] -
    deltas.random.v.ha.vrt$voc_rtg[i] # set up for ha - random
}
deltas.random.v.ha.vrt <- deltas.random.v.ha.vrt %>%
  filter(sample == "random") %>% # only keep meaningful vals
  ungroup() %>%
  select(aclew_child_id, d_voc_rtg) %>%
  mutate(delta = "va-random")
deltas.random.v.oth.vrt <- deltas.random.v.tt.vrt %>%
  bind_rows(deltas.random.v.ha.vrt) %>%
  full_join(ptcp.info, by = "aclew_child_id")
```

``` {r plot_sample_differences, message=FALSE, warning=FALSE, paged.print=FALSE}
# XDS/TDS/CDS mph and uph
# mph: deltas.random.v.oth
# uph: deltas.random.v.oth.utts
deltas.random.v.oth.input <- deltas.random.v.oth %>%
  full_join(select(deltas.random.v.oth.utts, aclew_child_id,
                   delta, d_xds_uph, d_tds_uph, d_cds_uph),
            by = c("aclew_child_id", "delta"))

# TDS MPH: Delta TDS mph between samples
mse.info <- tibble(
  delta = c("tt-random", "va-random"),
  means = c(deltas.random.v.oth.input %>%
              group_by(delta) %>%
              summarise(m = mean(d_tds_mph)) %>%
              select(m))[[1]],
  se = c(deltas.random.v.oth.input %>%
           group_by(delta) %>%
           summarise(se = sem(d_tds_mph)) %>%
           select(se))[[1]]
)
delta.tds.mph.plot <- ggplot(
  data = deltas.random.v.oth.input, aes(x = delta, y = d_tds_mph)) +
  geom_violin(data = deltas.random.v.oth.input, aes(x = delta, y = d_tds_mph)) +
  geom_jitter(data = deltas.random.v.oth.input, aes(x = delta, y = d_tds_mph),
              shape = 1, width = .1, size = 1) +
  geom_errorbar(data = mse.info,
                aes(y = means, ymax = means + (1.96 * se), ymin = means + (-1.96 * se)),
                    width = 0.25) +
  geom_point(data = mse.info, aes(y = means), size = 2) +
  geom_hline(yintercept = 0, lty = "dashed") +
  ylab(expression(paste(Delta,"TCDS (min/hr)"))) +
  ylim(c(-30,20)) +
  xlab("Samples compared") +
  scale_x_discrete(labels = c('TT - R','VA - R')) +
  theme_apa() +
  theme(axis.title.x = element_text(size=9),
	axis.title.y = element_text(size=9))

# XDS MPH: Delta XDS mph between samples
mse.info <- tibble(
  delta = c("tt-random", "va-random"),
  means = c(deltas.random.v.oth.input %>%
              group_by(delta) %>%
              summarise(m = mean(d_xds_mph)) %>%
              select(m))[[1]],
  se = c(deltas.random.v.oth.input %>%
           group_by(delta) %>%
           summarise(se = sem(d_xds_mph)) %>%
           select(se))[[1]]
)
delta.xds.mph.plot <- ggplot(
  data = deltas.random.v.oth.input, aes(x = delta, y = d_xds_mph)) +
  geom_violin(data = deltas.random.v.oth.input, aes(x = delta, y = d_xds_mph)) +
  geom_jitter(data = deltas.random.v.oth.input, aes(x = delta, y = d_xds_mph),
              shape = 1, width = .1, size = 1) +
  geom_errorbar(data = mse.info,
                aes(y = means, ymax = means + (1.96 * se), ymin = means + (-1.96 * se)),
                    width = 0.25) +
  geom_point(data = mse.info, aes(y = means), size = 2) +
  geom_hline(yintercept = 0, lty = "dashed") +
  ylab(expression(paste(Delta,"XDS (min/hr)"))) +
  ylim(c(-30,20)) +
  xlab("Samples compared") +
  scale_x_discrete(labels = c('TT - R','VA - R')) +
  theme_apa() +
  theme(axis.title.x = element_text(size=9),
	axis.title.y = element_text(size=9))

# TDS UPH: Delta TDS uph between samples
mse.info <- tibble(
  delta = c("tt-random", "va-random"),
  means = c(deltas.random.v.oth.input %>%
              group_by(delta) %>%
              summarise(m = mean(d_tds_uph)) %>%
              select(m))[[1]],
  se = c(deltas.random.v.oth.input %>%
           group_by(delta) %>%
           summarise(se = sem(d_tds_uph)) %>%
           select(se))[[1]]
)
delta.tds.uph.plot <- ggplot(
  data = deltas.random.v.oth.input, aes(x = delta, y = d_tds_uph)) +
  geom_violin(data = deltas.random.v.oth.input, aes(x = delta, y = d_tds_uph)) +
  geom_jitter(data = deltas.random.v.oth.input, aes(x = delta, y = d_tds_uph),
              shape = 1, width = .1, size = 1) +
  geom_errorbar(data = mse.info,
                aes(y = means, ymax = means + (1.96 * se), ymin = means + (-1.96 * se)),
                    width = 0.25) +
  geom_point(data = mse.info, aes(y = means), size = 2) +
  geom_hline(yintercept = 0, lty = "dashed") +
  ylab(expression(paste(Delta,"TCDS (utt/hr)"))) +
  ylim(c(-700,1000)) +
  xlab("Samples compared") +
  scale_x_discrete(labels = c('TT - R','VA - R')) +
  theme_apa() +
  theme(axis.title.x = element_text(size=9),
	axis.title.y = element_text(size=9))

# XDS UPH: Delta XDS uph between samples
mse.info <- tibble(
  delta = c("tt-random", "va-random"),
  means = c(deltas.random.v.oth.input %>%
              group_by(delta) %>%
              summarise(m = mean(d_xds_uph)) %>%
              select(m))[[1]],
  se = c(deltas.random.v.oth.input %>%
           group_by(delta) %>%
           summarise(se = sem(d_xds_uph)) %>%
           select(se))[[1]]
)
delta.xds.uph.plot <- ggplot(
  data = deltas.random.v.oth.input, aes(x = delta, y = d_xds_uph)) +
  geom_violin(data = deltas.random.v.oth.input, aes(x = delta, y = d_xds_uph)) +
  geom_jitter(data = deltas.random.v.oth.input, aes(x = delta, y = d_xds_uph),
              shape = 1, width = .1, size = 1) +
  geom_errorbar(data = mse.info,
                aes(y = means, ymax = means + (1.96 * se), ymin = means + (-1.96 * se)),
                    width = 0.25) +
  geom_point(data = mse.info, aes(y = means), size = 2) +
  geom_hline(yintercept = 0, lty = "dashed") +
  ylab(expression(paste(Delta,"XDS (utt/hr)"))) +
  ylim(c(-700,1000)) +
  xlab("Samples compared") +
  scale_x_discrete(labels = c('TT - R','VA - R')) +
  theme_apa() +
  theme(axis.title.x = element_text(size=9),
	axis.title.y = element_text(size=9))

grid.arrange(delta.tds.mph.plot,delta.xds.mph.plot,
             delta.tds.uph.plot,delta.xds.uph.plot, nrow=2, ncol=2)


# CHI VOC: Delta voc mph between samples
mse.info <- tibble(
  delta = c("tt-random", "va-random"),
  means = c(deltas.random.v.oth.cvc %>%
              group_by(delta) %>%
              summarise(m = mean(d_cvc_mph)) %>%
              select(m))[[1]],
  se = c(deltas.random.v.oth.cvc %>%
           group_by(delta) %>%
           summarise(se = sem(d_cvc_mph)) %>%
           select(se))[[1]]
)
delta.cvc.mph.plot <- ggplot(
  data = deltas.random.v.oth.cvc, aes(x = delta, y = d_cvc_mph)) +
  geom_violin(data = deltas.random.v.oth.cvc, aes(x = delta, y = d_cvc_mph)) +
  geom_jitter(data = deltas.random.v.oth.cvc, aes(x = delta, y = d_cvc_mph),
              shape = 1, width = .1, size = 1) +
  geom_errorbar(data = mse.info,
                aes(y = means, ymax = means + (1.96 * se), ymin = means + (-1.96 * se)),
                width = 0.25) +
  geom_point(data = mse.info, aes(y = means), size = 2) +
  geom_hline(yintercept = 0, lty = "dashed") +
  ylab(expression(paste(Delta,"CHI voc (min/hr)"))) +
  ylim(c(-10,20)) +
  xlab("Samples compared") +
  scale_x_discrete(labels = c('TT - R','VA - R')) +
  theme_apa() +
  theme(axis.title.x = element_text(size=9),
	axis.title.y = element_text(size=9))

# CHI VOC: Delta voc uph between samples
mse.info <- tibble(
  delta = c("tt-random", "va-random"),
  means = c(deltas.random.v.oth.cvc %>%
              group_by(delta) %>%
              summarise(m = mean(d_cvc_uph)) %>%
              select(m))[[1]],
  se = c(deltas.random.v.oth.cvc %>%
           group_by(delta) %>%
           summarise(se = sem(d_cvc_uph)) %>%
           select(se))[[1]]
)
delta.cvc.uph.plot <- ggplot(
  data = deltas.random.v.oth.cvc, aes(x = delta, y = d_cvc_uph)) +
  geom_violin(data = deltas.random.v.oth.cvc, aes(x = delta, y = d_cvc_uph)) +
  geom_jitter(data = deltas.random.v.oth.cvc, aes(x = delta, y = d_cvc_uph),
              shape = 1, width = .1, size = 1) +
  geom_errorbar(data = mse.info,
                aes(y = means, ymax = means + (1.96 * se), ymin = means + (-1.96 * se)),
                width = 0.25) +
  geom_point(data = mse.info, aes(y = means), size = 2) +
  geom_hline(yintercept = 0, lty = "dashed") +
  ylab(expression(paste(Delta,"CHI voc (utt/hr)"))) +
  ylim(c(-100,2000)) +
  xlab("Samples compared") +
  scale_x_discrete(labels = c('TT - R','VA - R')) +
  theme_apa() +
  theme(axis.title.x = element_text(size=9),
	axis.title.y = element_text(size=9))

# CHI VOCMAT: Delta voc mat rating between samples
mse.info <- tibble(
  delta = c("tt-random", "va-random"),
  means = c(deltas.random.v.oth.vrt %>%
              group_by(delta) %>%
              summarise(m = mean(d_voc_rtg)) %>%
              select(m))[[1]],
  se = c(deltas.random.v.oth.vrt %>%
           group_by(delta) %>%
           summarise(se = sem(d_voc_rtg)) %>%
           select(se))[[1]]
)
delta.voc.rtg.plot <- ggplot(
  data = deltas.random.v.oth.vrt, aes(x = delta, y = d_voc_rtg)) +
  geom_violin(data = deltas.random.v.oth.vrt, aes(x = delta, y = d_voc_rtg)) +
  geom_jitter(data = deltas.random.v.oth.vrt, aes(x = delta, y = d_voc_rtg),
              shape = 1, width = .1, size = 1) +
  geom_errorbar(data = mse.info,
                aes(y = means, ymax = means + (1.96 * se), ymin = means + (-1.96 * se)),
                width = 0.25) +
  geom_point(data = mse.info, aes(y = means), size = 2) +
  geom_hline(yintercept = 0, lty = "dashed") +
  ylab(expression(paste(Delta,"CHI voc mat (1-4)"))) +
  ylim(c(-.2,0.6)) +
  xlab("Samples compared") +
  scale_x_discrete(labels = c('TT - R','VA - R')) +
  theme_apa() +
  theme(axis.title.x = element_text(size=9),
	axis.title.y = element_text(size=9))

# TDS/CDS ttph: Delta O->C transitions between samples
mse.info <- tibble(
  delta = c("tt-random", "va-random"),
  means = c(deltas.random.v.oth.tth %>%
              group_by(delta) %>%
              summarise(m = mean(d_o_c.tth.tds)) %>%
              select(m))[[1]],
  se = c(deltas.random.v.oth.tth %>%
           group_by(delta) %>%
           summarise(se = sem(d_o_c.tth.tds)) %>%
           select(se))[[1]]
)
delta.tds.tth.o_c.plot <- ggplot(
  data = deltas.random.v.oth.tth, aes(x = delta, y = d_o_c.tth.tds)) +
  geom_violin(data = deltas.random.v.oth.tth, aes(x = delta, y = d_o_c.tth.tds)) +
  geom_jitter(data = deltas.random.v.oth.tth, aes(x = delta, y = d_o_c.tth.tds),
              shape = 1, width = .1, size = 1) +
  geom_errorbar(data = mse.info,
                aes(y = means, ymax = means + (1.96 * se), ymin = means + (-1.96 * se)),
                width = 0.25) +
  geom_point(data = mse.info, aes(y = means), size = 2) +
  geom_hline(yintercept = 0, lty = "dashed") +
  ylab(expression(paste(Delta,"OTH-TCHI (tt/hr)"))) +
  ylim(c(-100,600)) +
  xlab("Samples compared") +
  scale_x_discrete(labels = c('TT - R','VA - R')) +
  theme_apa() +
  theme(axis.title.x = element_text(size=9),
	axis.title.y = element_text(size=9))

# TDS/CDS ttph: Delta C->O transitions between samples
mse.info <- tibble(
  delta = c("tt-random", "va-random"),
  means = c(deltas.random.v.oth.tth %>%
              group_by(delta) %>%
              summarise(m = mean(d_c_o.tth.tds)) %>%
              select(m))[[1]],
  se = c(deltas.random.v.oth.tth %>%
           group_by(delta) %>%
           summarise(se = sem(d_c_o.tth.tds)) %>%
           select(se))[[1]]
)
delta.tds.tth.c_o.plot <- ggplot(
  data = deltas.random.v.oth.tth, aes(x = delta, y = d_c_o.tth.tds)) +
  geom_violin(data = deltas.random.v.oth.tth, aes(x = delta, y = d_c_o.tth.tds)) +
  geom_jitter(data = deltas.random.v.oth.tth, aes(x = delta, y = d_c_o.tth.tds),
              shape = 1, width = .1, size = 1) +
  geom_errorbar(data = mse.info,
                aes(y = means, ymax = means + (1.96 * se), ymin = means + (-1.96 * se)),
                    width = 0.25) +
  geom_point(data = mse.info, aes(y = means), size = 2) +
  geom_hline(yintercept = 0, lty = "dashed") +
  ylab(expression(paste(Delta,"TCHI-OTH (tt/hr)"))) +
  ylim(c(-100,600)) +
  xlab("Samples compared") +
  scale_x_discrete(labels = c('TT - R','VA - R')) +
  theme_apa() +
  theme(axis.title.x = element_text(size=9),
	axis.title.y = element_text(size=9))

grid.arrange(delta.cvc.mph.plot,delta.voc.rtg.plot,
             delta.tds.tth.o_c.plot, delta.tds.tth.c_o.plot, nrow=2, ncol=2)

```

``` {r prevalence_tt_estimate}
best.min.avgs <- tth.per.sample %>%
  filter(sample != "random") %>%
  select(-d_c_o.tth.cds, -d_c_o.tth.tds, -d_o_c.tth.cds, -d_o_c.tth.tds)

```

# Discussion


\newpage

# References
```{r create_r-references}
#r_refs(file = "r-references.bib")
```

\begingroup
\setlength{\parindent}{-0.5in}
\setlength{\leftskip}{0.5in}

<div id = "refs"></div>
\endgroup
